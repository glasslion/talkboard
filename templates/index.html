<!DOCTYPE html>
<html>
<head>
  <title>chat demo</title>
  <link rel="stylesheet" href="/static/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/codemirror.css">
  <style type="text/css">
  </style>

</head>
<body>
  <div class="container">
    <textarea id="text" class="form-control" rows=20></textarea>
  </div>

  <script src="/static/js/jquery-2.1.0.min.js" type="text/javascript"></script>
  <script src="/static/js/bootstrap.min.js"></script>
  <script src="/static/js/qrcode.min.js"></script>
  <script src="/static/js/codemirror.js"></script>
  <script type="text/javascript">
    (function() {

      var host = window.location.hostname;
      var $text = $('#text');
      var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("text"), {
          autofocus: true,
        }
      );
      var WebSocket = window.WebSocket || window.MozWebSocket;
      if (WebSocket) {
          try {
              var socket = new WebSocket('ws://'+host+':{{port}}/new-msg/socket');
          } catch (e) {}
      }

      var delay = (function(){
        var timer = 0;
        return function(callback, ms){
          clearTimeout (timer);
          timer = setTimeout(callback, ms);
        };
      })();

      var focus_to_end = function () {
        var textLen = $text.length;
        $text.selectionStart = textLen;
        $text.selectionEnd = textLen;
        $text.focus();
      }

      if (socket) {
          socket.onmessage = function(event) {
              $text.val(event.data);
              //focus_to_end();
          }

          $text.keyup(function() {
              delay(function(){
                socket.send($text.val());
              }, 3000 );
          });
      }



    })();
  </script>
</body>
</html>